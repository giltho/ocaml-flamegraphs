<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg class="flamegraph" version="1.1" width="800" height="154" xmlns="http://www.w3.org/2000/svg">
<style>
.frame {
  cursor: pointer;
}

.frame:hover rect {
  stroke: #000;
  stroke-width: 1;
}

text {
  pointer-events: none;
}

#reset-zoom {
  pointer-events: auto;
}
</style>
<rect x="0" y="0" width="100%" height="100%" fill="#f8f8f8"/>
<text x="10" y="24" font-size="16" font-family="monospace" font-weight="bold" fill="#000">Test Flamegraph</text>
<text x="790" y="24" font-size="12" font-family="monospace" fill="#666" text-anchor="end" id="reset-zoom" style="cursor:pointer">[Reset Zoom]</text>
<text x="10" y="42" font-size="12" font-family="monospace" fill="#666">Search: </text>
<foreignObject x="60" y="28" width="200" height="20">
<input xmlns="http://www.w3.org/1999/xhtml" id="search-input" type="text" style="width:190px;font-size:11px;border:1px solid #ccc;padding:2px;"/>
</foreignObject>
<text x="270" y="42" font-size="11" font-family="monospace" fill="#888" id="match-count"></text>
<text x="10" y="144" font-size="11" font-family="monospace" fill="#666" id="details"></text>
<g class="frame" transform="translate(10.00,108.00)">
<title>main (500.00, 100.00%)</title>
<rect x="0" y="0" width="780.00" height="15" fill="#c9e100" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">main</text>
</g>
<g class="frame" transform="translate(10.00,92.00)">
<title>process_request (380.00, 76.00%)</title>
<rect x="0" y="0" width="592.80" height="15" fill="#dcc800" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">process_request</text>
</g>
<g class="frame" transform="translate(10.00,76.00)">
<title>parse_json (180.00, 36.00%)</title>
<rect x="0" y="0" width="280.80" height="15" fill="#f98c00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">parse_json</text>
</g>
<g class="frame" transform="translate(10.00,60.00)">
<title>tokenize (100.00, 20.00%)</title>
<rect x="0" y="0" width="156.00" height="15" fill="#cc6900" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">tokenize</text>
</g>
<g class="frame" transform="translate(166.00,60.00)">
<title>validate (80.00, 16.00%)</title>
<rect x="0" y="0" width="124.80" height="15" fill="#e6aa00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">validate</text>
</g>
<g class="frame" transform="translate(290.80,76.00)">
<title>handle_data (200.00, 40.00%)</title>
<rect x="0" y="0" width="312.00" height="15" fill="#eaeb00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">handle_data</text>
</g>
<g class="frame" transform="translate(290.80,60.00)">
<title>compute (150.00, 30.00%)</title>
<rect x="0" y="0" width="234.00" height="15" fill="#dc8700" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">compute</text>
</g>
<g class="frame" transform="translate(524.80,60.00)">
<title>allocate (50.00, 10.00%)</title>
<rect x="0" y="0" width="78.00" height="15" fill="#facd00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">allocate</text>
</g>
<g class="frame" transform="translate(602.80,92.00)">
<title>init (50.00, 10.00%)</title>
<rect x="0" y="0" width="78.00" height="15" fill="#de5a00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">init</text>
</g>
<g class="frame" transform="translate(602.80,76.00)">
<title>load_config (30.00, 6.00%)</title>
<rect x="0" y="0" width="46.80" height="15" fill="#d7f000" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">load_config</text>
</g>
<g class="frame" transform="translate(649.60,76.00)">
<title>setup_logging (20.00, 4.00%)</title>
<rect x="0" y="0" width="31.20" height="15" fill="#efaa00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">setup_logging</text>
</g>
<g class="frame" transform="translate(680.80,92.00)">
<title>cleanup (70.00, 14.00%)</title>
<rect x="0" y="0" width="109.20" height="15" fill="#cdbe00" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">cleanup</text>
</g>
<g class="frame" transform="translate(680.80,76.00)">
<title>flush_buffers (70.00, 14.00%)</title>
<rect x="0" y="0" width="109.20" height="15" fill="#d3f000" rx="2" ry="2"/>
<text x="3" y="12" font-size="12" font-family="monospace" fill="#000">flush_buffers</text>
</g>
<script type="text/javascript">
<![CDATA[
(function() {
  "use strict";
  
  var svg = null;
  var frames = null;
  var searchInput = null;
  var matchCount = null;
  var details = null;
  var currentRoot = null;
  var originalTransforms = new Map();
  var originalWidths = new Map();
  var originalNames = new Map();
  
  var MIN_WIDTH_FOR_TEXT = 30;
  var TEXT_PADDING = 6; // 3px on each side
  
  function init() {
    svg = document.querySelector("svg.flamegraph");
    if (!svg) return;
    
    frames = svg.querySelectorAll("g.frame");
    searchInput = svg.querySelector("#search-input");
    matchCount = svg.querySelector("#match-count");
    details = svg.querySelector("#details");
    
    // Store original transforms, widths, and full text names
    frames.forEach(function(frame) {
      var rect = frame.querySelector("rect");
      var text = frame.querySelector("text");
      originalTransforms.set(frame, frame.getAttribute("transform") || "");
      originalWidths.set(rect, parseFloat(rect.getAttribute("width")));
      if (text) {
        originalNames.set(text, text.textContent);
      }
    });
    
    // Set up event handlers
    frames.forEach(function(frame) {
      frame.addEventListener("click", handleClick);
      frame.addEventListener("mouseover", handleMouseOver);
      frame.addEventListener("mouseout", handleMouseOut);
    });
    
    if (searchInput) {
      searchInput.addEventListener("input", handleSearch);
    }
    
    var resetBtn = svg.querySelector("#reset-zoom");
    if (resetBtn) {
      resetBtn.addEventListener("click", resetZoom);
    }
    
    // Initial text truncation for all frames
    updateAllText();
  }
  
  function handleClick(e) {
    e.stopPropagation();
    var frame = e.currentTarget;
    zoom(frame);
  }
  
  function handleMouseOver(e) {
    var frame = e.currentTarget;
    var rect = frame.querySelector("rect");
    var title = frame.querySelector("title");
    if (details && title) {
      details.textContent = title.textContent;
    }
    rect.style.stroke = "#000";
    rect.style.strokeWidth = "1";
  }
  
  function handleMouseOut(e) {
    var frame = e.currentTarget;
    var rect = frame.querySelector("rect");
    rect.style.stroke = "";
    rect.style.strokeWidth = "";
    if (details) {
      details.textContent = "";
    }
  }
  
  function getFrameData(frame) {
    var rect = frame.querySelector("rect");
    var transform = originalTransforms.get(frame) || "";
    var match = transform.match(/translate\(([\d.]+),\s*([\d.]+)\)/);
    var x = match ? parseFloat(match[1]) : 0;
    var y = match ? parseFloat(match[2]) : 0;
    var width = originalWidths.get(rect) || parseFloat(rect.getAttribute("width"));
    return { x: x, y: y, width: width, frame: frame };
  }
  
  /**
   * Truncate text to fit within available width using binary search.
   * Uses getComputedTextLength for accurate measurement.
   */
  function truncateText(text, availableWidth) {
    var fullName = originalNames.get(text);
    if (!fullName) return;
    
    // First, try with full name
    text.textContent = fullName;
    var textWidth = text.getComputedTextLength();
    
    if (textWidth <= availableWidth) {
      // Full name fits
      return;
    }
    
    // Need to truncate - use binary search to find optimal length
    var ellipsis = "..";
    var lo = 0;
    var hi = fullName.length;
    
    while (lo < hi) {
      var mid = Math.ceil((lo + hi) / 2);
      text.textContent = fullName.substring(0, mid) + ellipsis;
      textWidth = text.getComputedTextLength();
      
      if (textWidth <= availableWidth) {
        lo = mid;
      } else {
        hi = mid - 1;
      }
    }
    
    if (lo === 0) {
      // Can't fit even one character + ellipsis
      text.textContent = "";
    } else {
      text.textContent = fullName.substring(0, lo) + ellipsis;
    }
  }
  
  /**
   * Update text visibility and truncation for a single frame.
   */
  function updateFrameText(frame, rectWidth) {
    var text = frame.querySelector("text");
    if (!text) return;
    
    if (rectWidth < MIN_WIDTH_FOR_TEXT) {
      text.style.display = "none";
    } else {
      text.style.display = "";
      var availableWidth = rectWidth - TEXT_PADDING;
      truncateText(text, availableWidth);
    }
  }
  
  /**
   * Update text for all visible frames based on their current widths.
   */
  function updateAllText() {
    frames.forEach(function(frame) {
      if (frame.style.display === "none") return;
      var rect = frame.querySelector("rect");
      var rectWidth = parseFloat(rect.getAttribute("width"));
      updateFrameText(frame, rectWidth);
    });
  }
  
  function zoom(targetFrame) {
    var target = getFrameData(targetFrame);
    currentRoot = targetFrame;
    
    var svgWidth = parseFloat(svg.getAttribute("width")) - 20; // margins
    var svgHeight = parseFloat(svg.getAttribute("height"));
    var scale = svgWidth / target.width;
    var offsetX = target.x;
    var targetY = target.y;
    
    frames.forEach(function(frame) {
      var data = getFrameData(frame);
      var rect = frame.querySelector("rect");
      
      // Check if this frame is in the zoomed subtree
      var newX = (data.x - offsetX) * scale + 10;
      var newWidth = data.width * scale;
      
      // Hide frames outside the zoomed view
      // In bottom-up layout: hide frames below target (y > targetY) or outside x bounds
      if (data.y > targetY || newX + newWidth < 10 || newX > svgWidth + 10) {
        frame.style.display = "none";
      } else {
        frame.style.display = "";
        // Keep y position relative, shift so target ends up at bottom of graph area
        var newY = data.y + (svgHeight - 30 - 16) - targetY;
        frame.setAttribute("transform", "translate(" + newX + "," + newY + ")");
        rect.setAttribute("width", Math.max(0.5, newWidth));
        
        // Update text with new width
        updateFrameText(frame, newWidth);
      }
    });
  }
  
  function resetZoom() {
    currentRoot = null;
    frames.forEach(function(frame) {
      var rect = frame.querySelector("rect");
      var originalWidth = originalWidths.get(rect);
      frame.style.display = "";
      frame.setAttribute("transform", originalTransforms.get(frame) || "");
      rect.setAttribute("width", originalWidth);
      
      // Update text with original width
      updateFrameText(frame, originalWidth);
    });
  }
  
  function handleSearch() {
    var query = searchInput.value.toLowerCase().trim();
    var count = 0;
    
    frames.forEach(function(frame) {
      var rect = frame.querySelector("rect");
      var title = frame.querySelector("title");
      var name = title ? title.textContent.toLowerCase() : "";
      
      if (query && name.indexOf(query) !== -1) {
        rect.style.fill = "#ffff00";
        count++;
      } else {
        rect.style.fill = "";
      }
    });
    
    if (matchCount) {
      matchCount.textContent = query ? count + " matches" : "";
    }
  }
  
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();

]]>
</script>
</svg>
